

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Pandaos">
  <meta name="keywords" content="">
  
  <title>强网杯: unicorn_like_a_pro - Pandaos&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"panda0s.top","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Pandaos's blog" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Panadaos</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/atom.xml">
                <i class="iconfont icon-rss-fill"></i>
                Rss
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                Links
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="强网杯: unicorn_like_a_pro">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-06-14 21:11" pubdate>
        June 14, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      4.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      80
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">强网杯: unicorn_like_a_pro</h1>
            
            <div class="markdown-body">
              <h1 id="强网杯-unicorn-like-a-pro"><a href="#强网杯-unicorn-like-a-pro" class="headerlink" title="强网杯: unicorn_like_a_pro"></a>强网杯: unicorn_like_a_pro</h1><p>unicorn framework 是一个基于 qemu 的模拟执行框架</p>
<p>GitHub链接: <a target="_blank" rel="noopener" href="https://github.com/unicorn-engine/unicorn">https://github.com/unicorn-engine/unicorn</a></p>
<p>这道题目内部就调用了 unicorn 框架模拟执行一段 x64代码，最开始以为出题人魔改了 unicorn 框架，用 bindiff 分析了一段时间，发现并没有魔改 unicorn 代码</p>
<p>附件 原题 &amp; 脚本 &amp; idb: <a href="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/unicorn_idb_bin.zip" title="unicorn_idb_bin.zip">unicorn_idb_bin.zip</a></p>
<h2 id="1-符号还原"><a href="#1-符号还原" class="headerlink" title="1. 符号还原"></a>1. 符号还原</h2><p>本题没有符号，逆向时比较困难，用 bindiff 可以直接还原。</p>
<p>在 ubuntu 上编译一份 unicorn 代码，载入 bindiff 插件即可完成大部分符号还原。</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210613213557547.png" srcset="/img/loading.gif" lazyload class="" title="image-20210613213557547">

<p>IDA 中的 bindiff 插件，载入另外一份 idb 后，按下 Ctrl + 6, 点击 如下按钮，设置好阀值后即可导入符号</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210613213709484.png" srcset="/img/loading.gif" lazyload class="" title="image-20210613213709484">





<h2 id="2-main-函数分析"><a href="#2-main-函数分析" class="headerlink" title="2. main 函数分析"></a>2. main 函数分析</h2><p>2.1 创建虚拟机</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp">uc_open(<span class="hljs-number">4u</span>, <span class="hljs-number">8</span>, &amp;v14);                         <span class="hljs-comment">// UC_ARCH_X86, UC_MODE_64</span><br></code></pre></td></tr></table></figure>

<p>2.2 复制代码到虚拟机的 0x1000 地址</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">uc_mem_write</span>(v<span class="hljs-number">14</span>, <span class="hljs-number">0</span>x<span class="hljs-number">1000</span>LL, &amp;code, <span class="hljs-number">0</span>x<span class="hljs-number">1027</span>LL);<br></code></pre></td></tr></table></figure>

<p>2.3 设置回调</p>
<p>Unicorn 支持很多种回调类型，当 Unicorn 运行的代码满足特定的条件时，将触发对应的回调。</p>
<p>在回调中可以对虚拟机中环境上下文操作，类似调试器的调试回调。 </p>
<p>本题借助 Unicorn 指令回调，实现指令即时解密，执行后重新加密，打乱控制流。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// 虚拟机输入接口，虚拟机代码中的 in 指令</span><br>uc_hook_add(v14, &amp;trace, <span class="hljs-number">2</span>, input + <span class="hljs-number">1</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0xDA</span>u);<span class="hljs-comment">// 2 == UC_HOOK_INSN</span><br><span class="hljs-comment">// 虚拟机输出接口，虚拟机中代码中的 out 指令处理</span><br>uc_hook_add(v14, &amp;trace, <span class="hljs-number">2</span>, output, <span class="hljs-number">0LL</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0x1F4</span>u);<span class="hljs-comment">// 2 = UC_HOOK_INSN</span><br><span class="hljs-comment">// 虚拟机中 syscall 指令处理，设置 rax 寄存器的值为 time(0)</span><br>uc_hook_add(v14, &amp;trace, <span class="hljs-number">2</span>, syscall_time, <span class="hljs-number">0LL</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0x2BB</span>u);<span class="hljs-comment">// 2 = UC_HOOK_INSN</span><br><span class="hljs-comment">// 虚拟机中 fs 内存访问处理，改变 fs:0 的值，关键算法部分很重要</span><br>uc_hook_add(v14, &amp;trace, <span class="hljs-number">1024</span>, changeKey, <span class="hljs-number">0LL</span>, <span class="hljs-number">0x66660000</span>LL, <span class="hljs-number">0x66661000</span>LL, v4);<span class="hljs-comment">// UC_HOOK_MEM_READ</span><br><span class="hljs-comment">// 代码解密回调</span><br>uc_hook_add(v14, &amp;trace, <span class="hljs-number">8</span>, decrypt, &amp;v21, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, v5);<span class="hljs-comment">// UC_HOOK_BLOCK</span><br><span class="hljs-comment">// 代码控制流控制回调1</span><br>uc_hook_add(v14, &amp;trace, <span class="hljs-number">0x4000</span>,  ControlFlow1, &amp;v21, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, v6);<span class="hljs-comment">// UC_HOOK_INSN_INVALID</span><br><span class="hljs-comment">// 代码控制流控制回调2</span><br>uc_hook_add(v14, &amp;trace, <span class="hljs-number">4</span>,  ControlFlow2, &amp;v21, <span class="hljs-number">0x10A3</span>LL, <span class="hljs-number">0x10A4</span>LL, v7);<span class="hljs-comment">// UC_HOOK_CODE</span><br></code></pre></td></tr></table></figure>

<p>注意控制流有两个控制回调，第二个控制回调只在 0x10A3 地址处有效，就是特殊处理的地址。</p>
<h2 id="3-代码解密分析"><a href="#3-代码解密分析" class="headerlink" title="3. 代码解密分析"></a>3. 代码解密分析</h2><p>代码解密的主要逻辑在 decrypt 函数，该函数解密当前即将执行的基本块，加密上一个执行完的基本块</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c++">v9 = miniDec(lastKey, entry_rip);<br><span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">85</span>; ++i )<br>&#123;<br>  <span class="hljs-keyword">if</span> ( v9 == *&amp;size_table[<span class="hljs-number">8</span> * i] )<br>  &#123;<br>    size[<span class="hljs-number">0</span>] = *&amp;size_table[<span class="hljs-number">8</span> * i + <span class="hljs-number">4</span>];        <span class="hljs-comment">// getlen</span><br>    v12 = <span class="hljs-built_in">malloc</span>(size[<span class="hljs-number">0</span>]);<br>    uc_mem_read(v5, addr, v12, size[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; size[<span class="hljs-number">0</span>] &gt; j; ++j )<br>      ;<br>    dec1(v12, size[<span class="hljs-number">0</span>], lastKey);<br>    uc_mem_write(v5, addr, v12, size[<span class="hljs-number">0</span>]);<br>    <span class="hljs-keyword">for</span> ( k = <span class="hljs-number">0</span>; size[<span class="hljs-number">0</span>] &gt; k; ++k )<br>      ;<br>    <span class="hljs-built_in">free</span>(v12);<br>    *(*&amp;size[<span class="hljs-number">1</span>] + <span class="hljs-number">4LL</span>) = addr;<br>    *(*&amp;size[<span class="hljs-number">1</span>] + <span class="hljs-number">12LL</span>) = **&amp;size[<span class="hljs-number">1</span>];<br>    *(*&amp;size[<span class="hljs-number">1</span>] + <span class="hljs-number">8LL</span>) = size[<span class="hljs-number">0</span>];<br>    *(*&amp;size[<span class="hljs-number">1</span>] + <span class="hljs-number">16LL</span>) = addr;<br>    uc_reg_write(v5, <span class="hljs-number">41</span>, &amp;addr);              <span class="hljs-comment">// UC_X86_REG_RIP</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>基本块密钥用 miniDec 函数计算，参数为上一个基本块的入口密钥 lastKey 与当前基本块入口 rip, minidec 函数如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">miniDec</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a1, <span class="hljs-keyword">int</span> a2)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> a2 ^ a1 ^ (a2 * a1) ^ (a1 + a2);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>size_table 是一个数组，该数组保存了基本块密钥与基本块大小的关系，元素结构如下</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs processing">dd <span class="hljs-built_in">key</span><br>dd <span class="hljs-built_in">size</span><br></code></pre></td></tr></table></figure>

<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">size_table = [<span class="hljs-number">0x02F73020</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x09D3473A</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0x0EF87B55</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x147CB028</span>, <span class="hljs-number">0x00000023</span>, <span class="hljs-number">0x15F833AA</span>, <span class="hljs-number">0x00000030</span>, <span class="hljs-number">0x17086780</span>, <span class="hljs-number">0x00000018</span>, <span class="hljs-number">0x1733A9D4</span>, <span class="hljs-number">0x00000014</span>, <span class="hljs-number">0x17D61EE8</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0x1D52F19E</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x1F732DE0</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x1FBECFAD</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0x245BD7C8</span>, <span class="hljs-number">0x00000055</span>, <span class="hljs-number">0x25E7ABEE</span>, <span class="hljs-number">0x00000009</span>, <span class="hljs-number">0x2882C190</span>, <span class="hljs-number">0x000000A2</span>, <span class="hljs-number">0x2A2084A0</span>, <span class="hljs-number">0x00000075</span>, <span class="hljs-number">0x326AA6AE</span>, <span class="hljs-number">0x00000036</span>, <span class="hljs-number">0x33074A36</span>, <span class="hljs-number">0x00000024</span>, <span class="hljs-number">0x3440BD69</span>, <span class="hljs-number">0x0000002C</span>, <span class="hljs-number">0x362A1FC3</span>, <span class="hljs-number">0x0000002C</span>, <span class="hljs-number">0x3C0450D0</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x3CB575FD</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x41B3B26E</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0x46005120</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x465A72CF</span>, <span class="hljs-number">0x00000002</span>, <span class="hljs-number">0x492145A0</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x49AA4CE0</span>, <span class="hljs-number">0x0000002D</span>, <span class="hljs-number">0x4BD63647</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0x4BF84A87</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x4D102445</span>, <span class="hljs-number">0x00000033</span>, <span class="hljs-number">0x4D4D3C55</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0x53723232</span>, <span class="hljs-number">0x0000000A</span>, <span class="hljs-number">0x5809B5CB</span>, <span class="hljs-number">0x000000A2</span>, <span class="hljs-number">0x5B12FFCE</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x5B1F3000</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0x5D9FBD20</span>, <span class="hljs-number">0x00000027</span>, <span class="hljs-number">0x6219EED9</span>, <span class="hljs-number">0x0000008A</span>, <span class="hljs-number">0x65D82D17</span>, <span class="hljs-number">0x0000004C</span>, <span class="hljs-number">0x67F5671A</span>, <span class="hljs-number">0x00000063</span>, <span class="hljs-number">0x6CE2CBC1</span>, <span class="hljs-number">0x00000033</span>, <span class="hljs-number">0x718A739C</span>, <span class="hljs-number">0x0000000B</span>, <span class="hljs-number">0x71A62DD7</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x7693A1F6</span>, <span class="hljs-number">0x00000014</span>, <span class="hljs-number">0x7A473FB0</span>, <span class="hljs-number">0x00000047</span>, <span class="hljs-number">0x7AEFEDDC</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x7AF2CF90</span>, <span class="hljs-number">0x0000004F</span>, <span class="hljs-number">0x7BE0B8B0</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0x80EB3E88</span>, <span class="hljs-number">0x0000000A</span>, <span class="hljs-number">0x8213506A</span>, <span class="hljs-number">0x0000000C</span>, <span class="hljs-number">0x82468114</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x86B872A2</span>, <span class="hljs-number">0x0000001C</span>, <span class="hljs-number">0x87FBD296</span>, <span class="hljs-number">0x00000019</span>, <span class="hljs-number">0x88719339</span>, <span class="hljs-number">0x00000016</span>, <span class="hljs-number">0x89E2630A</span>, <span class="hljs-number">0x00000024</span>, <span class="hljs-number">0x8CB6536E</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0x92316E00</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x9415A51E</span>, <span class="hljs-number">0x0000004F</span>, <span class="hljs-number">0x94D658E0</span>, <span class="hljs-number">0x0000002B</span>, <span class="hljs-number">0x97E8DFCD</span>, <span class="hljs-number">0x00000036</span>, <span class="hljs-number">0x992E3874</span>, <span class="hljs-number">0x0000002A</span>, <span class="hljs-number">0x9B06958D</span>, <span class="hljs-number">0x00000030</span>, <span class="hljs-number">0x9B36B480</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0xA03CEFAD</span>, <span class="hljs-number">0x0000005A</span>, <span class="hljs-number">0xA39F47E6</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0xA946DEC4</span>, <span class="hljs-number">0x000000B4</span>, <span class="hljs-number">0xAE6173DC</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0xB044A68D</span>, <span class="hljs-number">0x0000008C</span>, <span class="hljs-number">0xB29E36A8</span>, <span class="hljs-number">0x0000000B</span>, <span class="hljs-number">0xB82781F4</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0xC14DFAF8</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xC3F42E20</span>, <span class="hljs-number">0x0000001E</span>, <span class="hljs-number">0xC5E0065E</span>, <span class="hljs-number">0x00000067</span>, <span class="hljs-number">0xCAD68B21</span>, <span class="hljs-number">0x00000039</span>, <span class="hljs-number">0xCBF29AC7</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xCE8729BC</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0xD2A85A94</span>, <span class="hljs-number">0x00000004</span>, <span class="hljs-number">0xD34FA4F3</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xD64611B0</span>, <span class="hljs-number">0x00000058</span>, <span class="hljs-number">0xD814FD56</span>, <span class="hljs-number">0x00000018</span>, <span class="hljs-number">0xDD386A80</span>, <span class="hljs-number">0x0000000A</span>, <span class="hljs-number">0xDE82DFAC</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xEC68D16F</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0xEEDE845B</span>, <span class="hljs-number">0x0000003F</span>, <span class="hljs-number">0xF235F260</span>, <span class="hljs-number">0x0000008D</span>, <span class="hljs-number">0xF9AA1F0B</span>, <span class="hljs-number">0x00000087</span>, <span class="hljs-number">0xFC200887</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xFED657A3</span>, <span class="hljs-number">0x0000000C</span>, <span class="hljs-number">0x00000000</span>]<br></code></pre></td></tr></table></figure>

<p>奇数下标数据为key，偶数为基本块字节的长度。</p>
<p>用 python 实现基本块解密函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuck</span>(<span class="hljs-params">prev_key, rip</span>):</span><br>    <span class="hljs-keyword">return</span> rip ^ prev_key ^ ((rip * prev_key) &amp; <span class="hljs-number">0xffffffff</span>) ^ (prev_key + rip)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deXor</span>(<span class="hljs-params">data, key</span>):</span><br>    key = p32(key)<br>    data = <span class="hljs-built_in">bytearray</span>(data)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):<br>        data[i] ^=  key[i % <span class="hljs-number">4</span>]<br>    <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_block</span>(<span class="hljs-params">key, rip</span>):</span><br>    key2 = fuck(key, rip)<br>    blockSize = get_size(key2)<br>    <span class="hljs-keyword">if</span> blockSize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        print(<span class="hljs-string">&quot;Not found1: rip:%x key:%x&quot;</span> % (rip, key2))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br>    offset = rip - <span class="hljs-number">0x1000</span><br>    code_data = code_bin[offset: offset + blockSize]<br>    code_data = deXor(code_data, key)<br>    next_rip = rip + blockSize - <span class="hljs-number">2</span><br>    key2 = fuck(key, next_rip)<br>    jmps = get_jmps(key2)<br>    <span class="hljs-keyword">return</span> code_data, jmps, next_rip<br></code></pre></td></tr></table></figure>

<p>这里的部分代码还涉及控制流重建，后面会提到。</p>
<h2 id="4-控制流分析"><a href="#4-控制流分析" class="headerlink" title="4. 控制流分析"></a>4. 控制流分析</h2><p>ControlFlow1 回调，执行到无效指令会被调用，用于切换程序中的控制流。</p>
<p>该题用 <code>3f 0f </code>作为基本块的结尾（无效指令）触发 ControlFlow1 回调，切换控制流。</p>
<p>ControlFlow1 回调函数根据结尾 rip 与 当前基本块的 key 计算另外一个 key，用于索引当前基本块的后继基本块的信息。</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210613220614232.png" srcset="/img/loading.gif" lazyload class="" title="image-20210613220614232">

<p>flowInfo 是一个数组，每一个元素有如下5个字段</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">dd</span> key<br><span class="hljs-attribute">dd</span> zf_<span class="hljs-number">0</span>_jmp  当基本块结尾 zf 标志寄存器为 <span class="hljs-number">0</span> 的跳转偏移，下面同理<br><span class="hljs-attribute">dd</span> zf_<span class="hljs-number">0</span>_key<br><span class="hljs-attribute">dd</span> zf_<span class="hljs-number">1</span>_jmp<br><span class="hljs-attribute">dd</span> zf_<span class="hljs-number">1</span>_key<br></code></pre></td></tr></table></figure>

<p>根据 zf 标志位跳转</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210613222926881.png" srcset="/img/loading.gif" lazyload class="" title="image-20210613222926881">

<p>注意 v9 保存的是上一个基本块的 key，此处做的 += 运算，即上一个基本块的 key 与 下一个基本块的 key 有关联。</p>
<p>由此可见，基本块的 key 与控制流的路径有关！写解密脚本的时候要考虑路径问题。</p>
<p>另外，当虚拟机中程序运行到 0x10A3 时将调整控制流并更改 key</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210614135822676.png" srcset="/img/loading.gif" lazyload class="" title="image-20210614135822676">



<p>解密后的基本块，很多都是以读取 fs 寄存器并判断结尾</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210614140832827.png" srcset="/img/loading.gif" lazyload class="" title="image-20210614140832827">

<p>r15 的值来源于 fs:xxx ，最后再与 fs:xxx 内存的值比较，很明显最后的 zf = 1。</p>
<p>其实并不是，这道题对 fs 寄存器指向的那段内存做了内存读回调，回调如下</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210614141153126.png" srcset="/img/loading.gif" lazyload class="" title="image-20210614141153126">

<p>每次读取 fs 指向的内存，该内存的值都会被改写。所以 mov 与 cmp 对 fs 内存访问出的结果是不同的，自然 zf = 0，走 zf = 0 的分支。</p>
<p>在控制流重建的时候，需要考虑以读取 fs 内存结尾的基本块，将其看作是无条件跳转，而不是 jz/jnz。</p>
<h2 id="5-控制流重建"><a href="#5-控制流重建" class="headerlink" title="5. 控制流重建"></a>5. 控制流重建</h2><p>重建思路：</p>
<p>以 bfs 遍历顺序，从入口基本块开始解密，解密后再查询分支信息表获取后继基本块的相对偏移与key，最后将新基本块的信息加入到队列，等待分析。遍历时注意维护路径上的 key 累计值。</p>
<p>所有基本块解密完成后，可以得到每个基本块的后继基本块的相对偏移。</p>
<p>要在基本块的结尾插入跳转指令，这将改变代码布局，使得原始相对偏移不可用，所以我采取重编译来解决这个问题，重编译之前将原始基本块的入口地址作为基本的符号名，基本块结尾用 jmp/jz 等指令连接。</p>
<p>code.bin 文件时 dump 出来的原始 code 数据，输出 1.bin 可以直接在 ida 中反编译。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> ctypes<br><span class="hljs-keyword">from</span> capstone <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> keystone <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>fuckTable = [<span class="hljs-number">0x00412F5E</span>, <span class="hljs-number">0xFFFFFA22</span>, <span class="hljs-number">0x14252652</span>, <span class="hljs-number">0xFFFFF9AC</span>, <span class="hljs-number">0x66CEF8EC</span>, <span class="hljs-number">0x0251D934</span>, <span class="hljs-number">0x0000009F</span>, <span class="hljs-number">0xC56FBF59</span>, <span class="hljs-number">0xFFFFFF61</span>, <span class="hljs-number">0xAA4D5B7C</span>, <span class="hljs-number">0x02745896</span>, <span class="hljs-number">0xFFFFFB7F</span>, <span class="hljs-number">0x34B6D31E</span>, <span class="hljs-number">0xFFFFFBB0</span>, <span class="hljs-number">0x302CC828</span>, <span class="hljs-number">0x02AC5992</span>, <span class="hljs-number">0xFFFFF524</span>, <span class="hljs-number">0x67CC4064</span>, <span class="hljs-number">0xFFFFF483</span>, <span class="hljs-number">0x8A5D9B26</span>, <span class="hljs-number">0x046254D0</span>, <span class="hljs-number">0xFFFFFC37</span>, <span class="hljs-number">0x074AB936</span>, <span class="hljs-number">0xFFFFFC7F</span>, <span class="hljs-number">0xB8EA37F7</span>, <span class="hljs-number">0x0CACD9FE</span>, <span class="hljs-number">0x0000007F</span>, <span class="hljs-number">0x6112F222</span>, <span class="hljs-number">0x00000002</span>, <span class="hljs-number">0x47A72561</span>, <span class="hljs-number">0x0F0FE6EB</span>, <span class="hljs-number">0xFFFFFBAE</span>, <span class="hljs-number">0x0A1411E7</span>, <span class="hljs-number">0xFFFFFC85</span>, <span class="hljs-number">0x3BE88B46</span>, <span class="hljs-number">0x0FC59DC2</span>, <span class="hljs-number">0xFFFFF72F</span>, <span class="hljs-number">0x7D12A5EF</span>, <span class="hljs-number">0xFFFFF691</span>, <span class="hljs-number">0xE67393D6</span>, <span class="hljs-number">0x10B1EBCA</span>, <span class="hljs-number">0x000001CF</span>, <span class="hljs-number">0x473A1295</span>, <span class="hljs-number">0x0000022E</span>, <span class="hljs-number">0x7BC15385</span>, <span class="hljs-number">0x1565D41D</span>, <span class="hljs-number">0xFFFFFDC4</span>, <span class="hljs-number">0x05D337BE</span>, <span class="hljs-number">0xFFFFFE7E</span>, <span class="hljs-number">0xE12982E4</span>, <span class="hljs-number">0x18909E40</span>, <span class="hljs-number">0x000005EB</span>, <span class="hljs-number">0xAE2337AF</span>, <span class="hljs-number">0x000005B1</span>, <span class="hljs-number">0x8E0AB2ED</span>, <span class="hljs-number">0x1AE7593A</span>, <span class="hljs-number">0xFFFFF3BC</span>, <span class="hljs-number">0x23E9058D</span>, <span class="hljs-number">0xFFFFF40B</span>, <span class="hljs-number">0xDFA6CF3E</span>, <span class="hljs-number">0x1B47DA81</span>, <span class="hljs-number">0xFFFFF8C3</span>, <span class="hljs-number">0x349CC616</span>, <span class="hljs-number">0xFFFFF7E9</span>, <span class="hljs-number">0x70C290D0</span>, <span class="hljs-number">0x1D816435</span>, <span class="hljs-number">0x00000002</span>, <span class="hljs-number">0x43F999C9</span>, <span class="hljs-number">0xFFFFFFD8</span>, <span class="hljs-number">0xAB0BCA16</span>, <span class="hljs-number">0x1DACC905</span>, <span class="hljs-number">0xFFFFFF54</span>, <span class="hljs-number">0x5C129962</span>, <span class="hljs-number">0xFFFFFD06</span>, <span class="hljs-number">0xE4515A41</span>, <span class="hljs-number">0x1E03B13C</span>, <span class="hljs-number">0xFFFFFF80</span>, <span class="hljs-number">0x7E763806</span>, <span class="hljs-number">0xFFFFF36A</span>, <span class="hljs-number">0xA25F3D93</span>, <span class="hljs-number">0x22FEFC06</span>, <span class="hljs-number">0xFFFFFCDD</span>, <span class="hljs-number">0xB94E0C2F</span>, <span class="hljs-number">0xFFFFFCB6</span>, <span class="hljs-number">0xF023033D</span>, <span class="hljs-number">0x26B1E690</span>, <span class="hljs-number">0xFFFFFDAB</span>, <span class="hljs-number">0xD0C7ED0C</span>, <span class="hljs-number">0xFFFFFE9B</span>, <span class="hljs-number">0xD49872C6</span>, <span class="hljs-number">0x2A652084</span>, <span class="hljs-number">0x000001EA</span>, <span class="hljs-number">0xDF9B65EE</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0x5CC5AB90</span>, <span class="hljs-number">0x2FBEBD25</span>, <span class="hljs-number">0x0000048F</span>, <span class="hljs-number">0x60A4E9F2</span>, <span class="hljs-number">0x000009AF</span>, <span class="hljs-number">0x42FE8B0D</span>, <span class="hljs-number">0x34F12D90</span>, <span class="hljs-number">0x000004C0</span>, <span class="hljs-number">0xF6257D94</span>, <span class="hljs-number">0x00000480</span>, <span class="hljs-number">0x5227DE21</span>, <span class="hljs-number">0x35F591D0</span>, <span class="hljs-number">0xFFFFFCA1</span>, <span class="hljs-number">0xDA83E113</span>, <span class="hljs-number">0xFFFFF998</span>, <span class="hljs-number">0x805C7ECB</span>, <span class="hljs-number">0x37EB0B72</span>, <span class="hljs-number">0xFFFFF3EC</span>, <span class="hljs-number">0x7480201A</span>, <span class="hljs-number">0xFFFFF903</span>, <span class="hljs-number">0xAC977E11</span>, <span class="hljs-number">0x389A58A8</span>, <span class="hljs-number">0x00000189</span>, <span class="hljs-number">0xE4005CD7</span>, <span class="hljs-number">0xFFFFFDEC</span>, <span class="hljs-number">0xB043695F</span>, <span class="hljs-number">0x3CB24155</span>, <span class="hljs-number">0x0000084C</span>, <span class="hljs-number">0x8ACB6FF1</span>, <span class="hljs-number">0x00000899</span>, <span class="hljs-number">0xACB471A5</span>, <span class="hljs-number">0x3DCBCDE3</span>, <span class="hljs-number">0x000007A8</span>, <span class="hljs-number">0xA84E3072</span>, <span class="hljs-number">0x00000384</span>, <span class="hljs-number">0xB2624259</span>, <span class="hljs-number">0x3F5290DE</span>, <span class="hljs-number">0xFFFFFE25</span>, <span class="hljs-number">0x8AC11F92</span>, <span class="hljs-number">0xFFFFFD8A</span>, <span class="hljs-number">0x44ACCD78</span>, <span class="hljs-number">0x47FF9B7E</span>, <span class="hljs-number">0x00000A81</span>, <span class="hljs-number">0x9833BF9C</span>, <span class="hljs-number">0x00000B35</span>, <span class="hljs-number">0x9B7199CD</span>, <span class="hljs-number">0x4C7867E6</span>, <span class="hljs-number">0x0000011C</span>, <span class="hljs-number">0x68BB4F80</span>, <span class="hljs-number">0x0000002E</span>, <span class="hljs-number">0x75B675CD</span>, <span class="hljs-number">0x53ADCD80</span>, <span class="hljs-number">0x000004E8</span>, <span class="hljs-number">0x6AA4F705</span>, <span class="hljs-number">0x00000452</span>, <span class="hljs-number">0xBA7C314B</span>, <span class="hljs-number">0x566E1640</span>, <span class="hljs-number">0x00000C8E</span>, <span class="hljs-number">0x203E3737</span>, <span class="hljs-number">0x00000C38</span>, <span class="hljs-number">0xF9367ED9</span>, <span class="hljs-number">0x5EDBB130</span>, <span class="hljs-number">0x000004FF</span>, <span class="hljs-number">0xD4F71A40</span>, <span class="hljs-number">0x000002AA</span>, <span class="hljs-number">0x35DC4141</span>, <span class="hljs-number">0x6C29C83A</span>, <span class="hljs-number">0x00000013</span>, <span class="hljs-number">0xBEAD8A76</span>, <span class="hljs-number">0xFFFFFFB5</span>, <span class="hljs-number">0x7A8A43EF</span>, <span class="hljs-number">0x6E036C9C</span>, <span class="hljs-number">0x00000BD5</span>, <span class="hljs-number">0x225F81E0</span>, <span class="hljs-number">0x00000D89</span>, <span class="hljs-number">0x3C25944D</span>, <span class="hljs-number">0x6FDCCE50</span>, <span class="hljs-number">0x00000605</span>, <span class="hljs-number">0xD3126740</span>, <span class="hljs-number">0x000003D5</span>, <span class="hljs-number">0xA3DA544C</span>, <span class="hljs-number">0x7132D345</span>, <span class="hljs-number">0x0000064E</span>, <span class="hljs-number">0x00915A5A</span>, <span class="hljs-number">0x000006DD</span>, <span class="hljs-number">0x5BCB6B22</span>, <span class="hljs-number">0x720DBD5C</span>, <span class="hljs-number">0x000008C3</span>, <span class="hljs-number">0x64DCFDF6</span>, <span class="hljs-number">0x00000858</span>, <span class="hljs-number">0x190B20BB</span>, <span class="hljs-number">0x7A035AD4</span>, <span class="hljs-number">0x00000424</span>, <span class="hljs-number">0x4DD955FB</span>, <span class="hljs-number">0x000004BF</span>, <span class="hljs-number">0xF65150B5</span>, <span class="hljs-number">0x7CBAED22</span>, <span class="hljs-number">0x00000AA1</span>, <span class="hljs-number">0x62CC154B</span>, <span class="hljs-number">0xFFFFFC58</span>, <span class="hljs-number">0x8DD5CEDB</span>, <span class="hljs-number">0x7EBF8EA8</span>, <span class="hljs-number">0x00000458</span>, <span class="hljs-number">0xCE844A0E</span>, <span class="hljs-number">0xFFFFF734</span>, <span class="hljs-number">0x9079D6BA</span>, <span class="hljs-number">0x804885CD</span>, <span class="hljs-number">0x000007BB</span>, <span class="hljs-number">0x89A8DA66</span>, <span class="hljs-number">0x00000136</span>, <span class="hljs-number">0x7185B813</span>, <span class="hljs-number">0x82190F37</span>, <span class="hljs-number">0xFFFFF58C</span>, <span class="hljs-number">0x013FA7D4</span>, <span class="hljs-number">0xFFFFF4AB</span>, <span class="hljs-number">0x7518093D</span>, <span class="hljs-number">0x83F7826A</span>, <span class="hljs-number">0x00000917</span>, <span class="hljs-number">0x2F33C3DD</span>, <span class="hljs-number">0xFFFFFBF0</span>, <span class="hljs-number">0x02A289B1</span>, <span class="hljs-number">0x8481BFD5</span>, <span class="hljs-number">0xFFFFF927</span>, <span class="hljs-number">0x72EED2D1</span>, <span class="hljs-number">0xFFFFF80A</span>, <span class="hljs-number">0xF46FD351</span>, <span class="hljs-number">0x85A69D6E</span>, <span class="hljs-number">0x000000B4</span>, <span class="hljs-number">0x27A3BB0F</span>, <span class="hljs-number">0x00000181</span>, <span class="hljs-number">0x49235BC0</span>, <span class="hljs-number">0x85F73150</span>, <span class="hljs-number">0x00000259</span>, <span class="hljs-number">0xA300692F</span>, <span class="hljs-number">0x000009BD</span>, <span class="hljs-number">0x5A3E46A9</span>, <span class="hljs-number">0x86E2497A</span>, <span class="hljs-number">0xFFFFFB53</span>, <span class="hljs-number">0xE7614707</span>, <span class="hljs-number">0xFFFFFBB3</span>, <span class="hljs-number">0xFA190B2A</span>, <span class="hljs-number">0x8B261F60</span>, <span class="hljs-number">0xFFFFF323</span>, <span class="hljs-number">0x97B9CC33</span>, <span class="hljs-number">0xFFFFFAB7</span>, <span class="hljs-number">0x2CB73BF0</span>, <span class="hljs-number">0x8B42B00C</span>, <span class="hljs-number">0x00000871</span>, <span class="hljs-number">0xA57A2DE3</span>, <span class="hljs-number">0x00000797</span>, <span class="hljs-number">0xA73082D6</span>, <span class="hljs-number">0x8E4C5C94</span>, <span class="hljs-number">0x000000FE</span>, <span class="hljs-number">0xEE4B594B</span>, <span class="hljs-number">0xFFFFF999</span>, <span class="hljs-number">0xDCE3B74D</span>, <span class="hljs-number">0x913A9FDB</span>, <span class="hljs-number">0xFFFFFE1C</span>, <span class="hljs-number">0x1BFFA329</span>, <span class="hljs-number">0xFFFFFD31</span>, <span class="hljs-number">0x49B21C95</span>, <span class="hljs-number">0x922BFB96</span>, <span class="hljs-number">0xFFFFF61B</span>, <span class="hljs-number">0x4FAFD829</span>, <span class="hljs-number">0xFFFFFBBA</span>, <span class="hljs-number">0x6BD5D317</span>, <span class="hljs-number">0x9F4B8702</span>, <span class="hljs-number">0xFFFFFEC1</span>, <span class="hljs-number">0xB691AD49</span>, <span class="hljs-number">0xFFFFFEF2</span>, <span class="hljs-number">0xCE6C6FE9</span>, <span class="hljs-number">0xA2CEAAA6</span>, <span class="hljs-number">0xFFFFFD89</span>, <span class="hljs-number">0x60E52701</span>, <span class="hljs-number">0xFFFFFCB2</span>, <span class="hljs-number">0x25AD9A9D</span>, <span class="hljs-number">0xAA970D72</span>, <span class="hljs-number">0xFFFFF2BB</span>, <span class="hljs-number">0xC1F58CAC</span>, <span class="hljs-number">0xFFFFF2AB</span>, <span class="hljs-number">0x20B8FE22</span>, <span class="hljs-number">0xABC02B72</span>, <span class="hljs-number">0xFFFFF94B</span>, <span class="hljs-number">0xFF6EA5A6</span>, <span class="hljs-number">0xFFFFFA6A</span>, <span class="hljs-number">0x1CD46647</span>, <span class="hljs-number">0xAE535E9E</span>, <span class="hljs-number">0x000003EC</span>, <span class="hljs-number">0x31246F6B</span>, <span class="hljs-number">0x0000035B</span>, <span class="hljs-number">0x50E2A20A</span>, <span class="hljs-number">0xB7337941</span>, <span class="hljs-number">0xFFFFF856</span>, <span class="hljs-number">0xD1A79AD7</span>, <span class="hljs-number">0xFFFFF955</span>, <span class="hljs-number">0x14673B75</span>, <span class="hljs-number">0xBB8DB95E</span>, <span class="hljs-number">0xFFFFFEEB</span>, <span class="hljs-number">0x6A7F1E5A</span>, <span class="hljs-number">0xFFFFF3B3</span>, <span class="hljs-number">0x1EF2F3AA</span>, <span class="hljs-number">0xBC1EDA22</span>, <span class="hljs-number">0xFFFFFB90</span>, <span class="hljs-number">0xE247955F</span>, <span class="hljs-number">0xFFFFFCE6</span>, <span class="hljs-number">0xA0351A85</span>, <span class="hljs-number">0xBCD91FE8</span>, <span class="hljs-number">0x0000008C</span>, <span class="hljs-number">0x71A348B9</span>, <span class="hljs-number">0x00000030</span>, <span class="hljs-number">0x821754EF</span>, <span class="hljs-number">0xBD38E305</span>, <span class="hljs-number">0xFFFFFF59</span>, <span class="hljs-number">0xE694333F</span>, <span class="hljs-number">0xFFFFFEF9</span>, <span class="hljs-number">0x436B1A45</span>, <span class="hljs-number">0xBE1AA65A</span>, <span class="hljs-number">0xFFFFF93D</span>, <span class="hljs-number">0x8761A810</span>, <span class="hljs-number">0xFFFFFEEB</span>, <span class="hljs-number">0xB2DB19FA</span>, <span class="hljs-number">0xC052453C</span>, <span class="hljs-number">0x000009B5</span>, <span class="hljs-number">0xB05027D7</span>, <span class="hljs-number">0x000009C5</span>, <span class="hljs-number">0xBCA91679</span>, <span class="hljs-number">0xC4A2D780</span>, <span class="hljs-number">0x000008B9</span>, <span class="hljs-number">0xE42FD068</span>, <span class="hljs-number">0x000007C1</span>, <span class="hljs-number">0x9F8B2B83</span>, <span class="hljs-number">0xC6A236BA</span>, <span class="hljs-number">0xFFFFFDBB</span>, <span class="hljs-number">0x20649A12</span>, <span class="hljs-number">0xFFFFFD09</span>, <span class="hljs-number">0x5F73FD94</span>, <span class="hljs-number">0xC6BB5160</span>, <span class="hljs-number">0xFFFFFE90</span>, <span class="hljs-number">0x0ED42674</span>, <span class="hljs-number">0xFFFFFF4B</span>, <span class="hljs-number">0xA76699CC</span>, <span class="hljs-number">0xCB74E940</span>, <span class="hljs-number">0x000003E3</span>, <span class="hljs-number">0x7DA194FF</span>, <span class="hljs-number">0xFFFFFCDA</span>, <span class="hljs-number">0xB23E5B15</span>, <span class="hljs-number">0xD027B387</span>, <span class="hljs-number">0xFFFFF701</span>, <span class="hljs-number">0x880BCC4F</span>, <span class="hljs-number">0xFFFFF785</span>, <span class="hljs-number">0xFEA3D685</span>, <span class="hljs-number">0xD1127D6B</span>, <span class="hljs-number">0xFFFFFAC0</span>, <span class="hljs-number">0xDF3D499A</span>, <span class="hljs-number">0x00000362</span>, <span class="hljs-number">0x84B7777D</span>, <span class="hljs-number">0xD6F5F913</span>, <span class="hljs-number">0xFFFFFCCD</span>, <span class="hljs-number">0xA5D89DB8</span>, <span class="hljs-number">0xFFFFFCAB</span>, <span class="hljs-number">0xF69BAE29</span>, <span class="hljs-number">0xDD04F828</span>, <span class="hljs-number">0xFFFFF705</span>, <span class="hljs-number">0xE18F3BA0</span>, <span class="hljs-number">0xFFFFF64D</span>, <span class="hljs-number">0xEBC799B0</span>, <span class="hljs-number">0xDDF22CB8</span>, <span class="hljs-number">0x0000075D</span>, <span class="hljs-number">0x47F7B857</span>, <span class="hljs-number">0x000001B3</span>, <span class="hljs-number">0x5C1CDEA9</span>, <span class="hljs-number">0xDF34D0A8</span>, <span class="hljs-number">0x0000014D</span>, <span class="hljs-number">0xBFE2CAD5</span>, <span class="hljs-number">0x00000201</span>, <span class="hljs-number">0x1F0C8A89</span>, <span class="hljs-number">0xE146EA40</span>, <span class="hljs-number">0x0000046D</span>, <span class="hljs-number">0x189EB8F9</span>, <span class="hljs-number">0xFFFFF6FB</span>, <span class="hljs-number">0x4CA1090D</span>, <span class="hljs-number">0xE231C560</span>, <span class="hljs-number">0x00000710</span>, <span class="hljs-number">0x2E586529</span>, <span class="hljs-number">0xFFFFFF17</span>, <span class="hljs-number">0x0E9AA776</span>, <span class="hljs-number">0xE2FC6838</span>, <span class="hljs-number">0x00000733</span>, <span class="hljs-number">0xB73DDD7A</span>, <span class="hljs-number">0x00000753</span>, <span class="hljs-number">0x14A1BDE4</span>, <span class="hljs-number">0xE44AE35D</span>, <span class="hljs-number">0x000002C8</span>, <span class="hljs-number">0x46B1F3D1</span>, <span class="hljs-number">0xFFFFFA2D</span>, <span class="hljs-number">0xD2295816</span>, <span class="hljs-number">0xE5AF4AB1</span>, <span class="hljs-number">0x00000DB0</span>, <span class="hljs-number">0x0AFF4FF9</span>, <span class="hljs-number">0x00000D91</span>, <span class="hljs-number">0xB17A4340</span>, <span class="hljs-number">0xE7E3CF21</span>, <span class="hljs-number">0x00000656</span>, <span class="hljs-number">0x9FC50924</span>, <span class="hljs-number">0x00000658</span>, <span class="hljs-number">0x31615022</span>, <span class="hljs-number">0xE8815965</span>, <span class="hljs-number">0x00000BCB</span>, <span class="hljs-number">0x6F51A655</span>, <span class="hljs-number">0x00000C0A</span>, <span class="hljs-number">0x72F5680C</span>, <span class="hljs-number">0xEBDF0F14</span>, <span class="hljs-number">0xFFFFF2B1</span>, <span class="hljs-number">0xD36EC5D4</span>, <span class="hljs-number">0xFFFFF239</span>, <span class="hljs-number">0x3B711343</span>, <span class="hljs-number">0xEC12E59B</span>, <span class="hljs-number">0x00000270</span>, <span class="hljs-number">0x3A38D2E8</span>, <span class="hljs-number">0x0000023D</span>, <span class="hljs-number">0x68D07674</span>, <span class="hljs-number">0xF4013920</span>, <span class="hljs-number">0x00000703</span>, <span class="hljs-number">0xD83CCFAA</span>, <span class="hljs-number">0x000007BA</span>, <span class="hljs-number">0x46891EEB</span>, <span class="hljs-number">0xF6847EC1</span>, <span class="hljs-number">0xFFFFFE62</span>, <span class="hljs-number">0x6D4BAAFC</span>, <span class="hljs-number">0xFFFFFD92</span>, <span class="hljs-number">0x5E6F5A94</span>]<br><br><br>size_table = [<span class="hljs-number">0x02F73020</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x09D3473A</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0x0EF87B55</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x147CB028</span>, <span class="hljs-number">0x00000023</span>, <span class="hljs-number">0x15F833AA</span>, <span class="hljs-number">0x00000030</span>, <span class="hljs-number">0x17086780</span>, <span class="hljs-number">0x00000018</span>, <span class="hljs-number">0x1733A9D4</span>, <span class="hljs-number">0x00000014</span>, <span class="hljs-number">0x17D61EE8</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0x1D52F19E</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x1F732DE0</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x1FBECFAD</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0x245BD7C8</span>, <span class="hljs-number">0x00000055</span>, <span class="hljs-number">0x25E7ABEE</span>, <span class="hljs-number">0x00000009</span>, <span class="hljs-number">0x2882C190</span>, <span class="hljs-number">0x000000A2</span>, <span class="hljs-number">0x2A2084A0</span>, <span class="hljs-number">0x00000075</span>, <span class="hljs-number">0x326AA6AE</span>, <span class="hljs-number">0x00000036</span>, <span class="hljs-number">0x33074A36</span>, <span class="hljs-number">0x00000024</span>, <span class="hljs-number">0x3440BD69</span>, <span class="hljs-number">0x0000002C</span>, <span class="hljs-number">0x362A1FC3</span>, <span class="hljs-number">0x0000002C</span>, <span class="hljs-number">0x3C0450D0</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x3CB575FD</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x41B3B26E</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0x46005120</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x465A72CF</span>, <span class="hljs-number">0x00000002</span>, <span class="hljs-number">0x492145A0</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x49AA4CE0</span>, <span class="hljs-number">0x0000002D</span>, <span class="hljs-number">0x4BD63647</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0x4BF84A87</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0x4D102445</span>, <span class="hljs-number">0x00000033</span>, <span class="hljs-number">0x4D4D3C55</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0x53723232</span>, <span class="hljs-number">0x0000000A</span>, <span class="hljs-number">0x5809B5CB</span>, <span class="hljs-number">0x000000A2</span>, <span class="hljs-number">0x5B12FFCE</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x5B1F3000</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0x5D9FBD20</span>, <span class="hljs-number">0x00000027</span>, <span class="hljs-number">0x6219EED9</span>, <span class="hljs-number">0x0000008A</span>, <span class="hljs-number">0x65D82D17</span>, <span class="hljs-number">0x0000004C</span>, <span class="hljs-number">0x67F5671A</span>, <span class="hljs-number">0x00000063</span>, <span class="hljs-number">0x6CE2CBC1</span>, <span class="hljs-number">0x00000033</span>, <span class="hljs-number">0x718A739C</span>, <span class="hljs-number">0x0000000B</span>, <span class="hljs-number">0x71A62DD7</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x7693A1F6</span>, <span class="hljs-number">0x00000014</span>, <span class="hljs-number">0x7A473FB0</span>, <span class="hljs-number">0x00000047</span>, <span class="hljs-number">0x7AEFEDDC</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x7AF2CF90</span>, <span class="hljs-number">0x0000004F</span>, <span class="hljs-number">0x7BE0B8B0</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0x80EB3E88</span>, <span class="hljs-number">0x0000000A</span>, <span class="hljs-number">0x8213506A</span>, <span class="hljs-number">0x0000000C</span>, <span class="hljs-number">0x82468114</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0x86B872A2</span>, <span class="hljs-number">0x0000001C</span>, <span class="hljs-number">0x87FBD296</span>, <span class="hljs-number">0x00000019</span>, <span class="hljs-number">0x88719339</span>, <span class="hljs-number">0x00000016</span>, <span class="hljs-number">0x89E2630A</span>, <span class="hljs-number">0x00000024</span>, <span class="hljs-number">0x8CB6536E</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0x92316E00</span>, <span class="hljs-number">0x00000015</span>, <span class="hljs-number">0x9415A51E</span>, <span class="hljs-number">0x0000004F</span>, <span class="hljs-number">0x94D658E0</span>, <span class="hljs-number">0x0000002B</span>, <span class="hljs-number">0x97E8DFCD</span>, <span class="hljs-number">0x00000036</span>, <span class="hljs-number">0x992E3874</span>, <span class="hljs-number">0x0000002A</span>, <span class="hljs-number">0x9B06958D</span>, <span class="hljs-number">0x00000030</span>, <span class="hljs-number">0x9B36B480</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0xA03CEFAD</span>, <span class="hljs-number">0x0000005A</span>, <span class="hljs-number">0xA39F47E6</span>, <span class="hljs-number">0x0000004E</span>, <span class="hljs-number">0xA946DEC4</span>, <span class="hljs-number">0x000000B4</span>, <span class="hljs-number">0xAE6173DC</span>, <span class="hljs-number">0x00000051</span>, <span class="hljs-number">0xB044A68D</span>, <span class="hljs-number">0x0000008C</span>, <span class="hljs-number">0xB29E36A8</span>, <span class="hljs-number">0x0000000B</span>, <span class="hljs-number">0xB82781F4</span>, <span class="hljs-number">0x0000000D</span>, <span class="hljs-number">0xC14DFAF8</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xC3F42E20</span>, <span class="hljs-number">0x0000001E</span>, <span class="hljs-number">0xC5E0065E</span>, <span class="hljs-number">0x00000067</span>, <span class="hljs-number">0xCAD68B21</span>, <span class="hljs-number">0x00000039</span>, <span class="hljs-number">0xCBF29AC7</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xCE8729BC</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0xD2A85A94</span>, <span class="hljs-number">0x00000004</span>, <span class="hljs-number">0xD34FA4F3</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xD64611B0</span>, <span class="hljs-number">0x00000058</span>, <span class="hljs-number">0xD814FD56</span>, <span class="hljs-number">0x00000018</span>, <span class="hljs-number">0xDD386A80</span>, <span class="hljs-number">0x0000000A</span>, <span class="hljs-number">0xDE82DFAC</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xEC68D16F</span>, <span class="hljs-number">0x0000001B</span>, <span class="hljs-number">0xEEDE845B</span>, <span class="hljs-number">0x0000003F</span>, <span class="hljs-number">0xF235F260</span>, <span class="hljs-number">0x0000008D</span>, <span class="hljs-number">0xF9AA1F0B</span>, <span class="hljs-number">0x00000087</span>, <span class="hljs-number">0xFC200887</span>, <span class="hljs-number">0x00000011</span>, <span class="hljs-number">0xFED657A3</span>, <span class="hljs-number">0x0000000C</span>, <span class="hljs-number">0x00000000</span>]<br>zf_0_jmp = <span class="hljs-number">0</span><br>zf_0_key = <span class="hljs-number">1</span><br>zf_1_jmp = <span class="hljs-number">2</span><br>zf_1_key = <span class="hljs-number">3</span><br><br><br>code_bin = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;code.bin&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>).read()<br>print(<span class="hljs-string">&quot;code size: &quot;</span>, <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(code_bin)))<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_size</span>(<span class="hljs-params">key</span>):</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">85</span>):<br>        <span class="hljs-keyword">if</span> size_table[i * <span class="hljs-number">2</span>] == key:<br>            <span class="hljs-keyword">return</span>  size_table[i * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_jmps</span>(<span class="hljs-params">key</span>):</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">85</span>):<br>        base = i * <span class="hljs-number">5</span><br>        <span class="hljs-keyword">if</span> fuckTable[base] == key:<br>            <span class="hljs-comment"># zf_0_jmp, zf_0_key, zf_1_jmp, zf_1_key</span><br>            <span class="hljs-keyword">return</span> fuckTable[base + <span class="hljs-number">1</span>: base + <span class="hljs-number">5</span>]<br>    print(<span class="hljs-string">&quot;not found2: &quot;</span>, <span class="hljs-built_in">hex</span>(key))<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">fuck</span>(<span class="hljs-params">prev_key, rip</span>):</span><br>    <span class="hljs-keyword">return</span> rip ^ prev_key ^ ((rip * prev_key) &amp; <span class="hljs-number">0xffffffff</span>) ^ (prev_key + rip)<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">deXor</span>(<span class="hljs-params">data, key</span>):</span><br>    key = p32(key)<br>    data = <span class="hljs-built_in">bytearray</span>(data)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(data)):<br>        data[i] ^=  key[i % <span class="hljs-number">4</span>]<br>    <span class="hljs-keyword">return</span> data<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decrypt_block</span>(<span class="hljs-params">key, rip</span>):</span><br>    key2 = fuck(key, rip)<br>    blockSize = get_size(key2)<br><br>    <span class="hljs-keyword">if</span> blockSize <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        print(<span class="hljs-string">&quot;Not found1: rip:%x key:%x&quot;</span> % (rip, key2))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span><br><br>    offset = rip - <span class="hljs-number">0x1000</span><br>    code_data = code_bin[offset: offset + blockSize]<br>    code_data = deXor(code_data, key)<br>    next_rip = rip + blockSize - <span class="hljs-number">2</span><br>    key2 = fuck(key, next_rip)<br><br>    jmps = get_jmps(key2)<br><br>    <span class="hljs-keyword">return</span> code_data, jmps, next_rip<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span>:</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, data, rip</span>):</span><br>        self.code_data = data<br>        self.child1 = <span class="hljs-number">0</span><br>        self.child2 = <span class="hljs-number">0</span><br>        self.end_rip = <span class="hljs-literal">None</span><br>        self.rip = rip<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">disasm</span>(<span class="hljs-params">data, baseaddr</span>):</span><br>    md = Cs(CS_ARCH_X86, CS_MODE_64)<br>    ins = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> md.disasm(data, baseaddr):<br>        asm_code = <span class="hljs-string">&quot;%s\t%s&quot;</span> % (i.mnemonic, i.op_str)<br>        ins += asm_code + <span class="hljs-string">&quot;\n&quot;</span><br>    <span class="hljs-keyword">return</span> ins<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">buildNode</span>(<span class="hljs-params">key_, rip_</span>):</span><br>    work_queue = [(key_, rip_)]<br>    log_map = &#123;&#125;<br>    <span class="hljs-keyword">while</span> <span class="hljs-built_in">len</span>(work_queue) &gt; <span class="hljs-number">0</span>:<br>        T = work_queue[<span class="hljs-number">0</span>]<br>        work_queue.remove(T)<br>        key, rip = T<br><br><br>        <span class="hljs-keyword">if</span> rip <span class="hljs-keyword">in</span> log_map:<br>            <span class="hljs-keyword">continue</span><br><br>        <span class="hljs-keyword">if</span> rip == <span class="hljs-number">0x10A3</span>:<br>            key -= <span class="hljs-number">0x2B09B990</span><br>            rip = <span class="hljs-number">0x1EEC</span><br><br>        code_data, jmps, next_rip = decrypt_block(key, rip)<br><br>        <span class="hljs-keyword">if</span> code_data <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">continue</span><br><br>        node_cur = Node(code_data, rip)<br><br>        node_cur.end_rip = next_rip<br>        log_map[rip] = node_cur<br><br>        <span class="hljs-keyword">if</span> jmps <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            <span class="hljs-keyword">continue</span><br><br>        asm_text = disasm(node_cur.code_data, rip)<br><br><br>        newrip = next_rip + ctypes.c_int32(jmps[zf_0_jmp]).value<br>        node_cur.child1 = newrip<br>        <span class="hljs-keyword">if</span> newrip <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> log_map:<br>            work_queue.append(((key + jmps[zf_0_key]) &amp; <span class="hljs-number">0xffffffff</span>, newrip))<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;qword ptr fs:[&#x27;</span> <span class="hljs-keyword">in</span> asm_text.splitlines()[-<span class="hljs-number">1</span>]:<br>            <span class="hljs-keyword">continue</span><br><br><br>        newrip = next_rip + ctypes.c_int32(jmps[zf_1_jmp]).value<br>        node_cur.child2 = newrip<br>        <span class="hljs-keyword">if</span> newrip <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> log_map:<br>            work_queue.append(((key + jmps[zf_1_key]) &amp; <span class="hljs-number">0xffffffff</span>, newrip))<br><br><br>    jmptables = &#123;&#125;<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(log_map.keys()):<br>        <span class="hljs-keyword">if</span> log_map[i].child1 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            log_map[i].child1 = <span class="hljs-number">0</span><br><br>        <span class="hljs-keyword">if</span> log_map[i].child2 <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>            log_map[i].child2 = <span class="hljs-number">0</span><br><br>        jmptables[<span class="hljs-built_in">hex</span>(log_map[i].end_rip)] = (<span class="hljs-built_in">hex</span>(log_map[i].rip), <span class="hljs-built_in">hex</span>(log_map[i].child1), <span class="hljs-built_in">hex</span>(log_map[i].child2))<br>    print(<span class="hljs-string">&quot;len:&quot;</span>, <span class="hljs-built_in">len</span>(jmptables))<br>    print(jmptables)<br><br>    all_asm = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">sorted</span>(log_map.keys()):<br>        print(<span class="hljs-built_in">hex</span>(i))<br>        node = log_map[i]<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-number">0x1EEC</span>:<br>            all_asm += <span class="hljs-string">&quot;_0x10a3:\n&quot;</span><br><br>        all_asm += <span class="hljs-string">&quot;_&quot;</span> + <span class="hljs-built_in">hex</span>(i) + <span class="hljs-string">&quot;:\n&quot;</span><br>        all_asm += disasm(node.code_data, i)<br>        <br>        <span class="hljs-keyword">if</span> node.child1 != <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> node.child2 != <span class="hljs-number">0</span>:<br>            jmp_code = <span class="hljs-string">&quot;jz _&quot;</span> + <span class="hljs-built_in">hex</span>(node.child2) + <span class="hljs-string">&quot;\n&quot;</span><br>            jmp_code += <span class="hljs-string">&quot;jmp _&quot;</span> + <span class="hljs-built_in">hex</span>(node.child1) + <span class="hljs-string">&quot;\n&quot;</span><br><br>        <span class="hljs-keyword">elif</span> node.child1 == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> node.child2 != <span class="hljs-number">0</span>:<br>            jmp_code = <span class="hljs-string">&quot;jmp _&quot;</span> + <span class="hljs-built_in">hex</span>(node.child2) + <span class="hljs-string">&quot;\n&quot;</span><br><br>        <span class="hljs-keyword">elif</span> node.child2 == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> node.child1 != <span class="hljs-number">0</span>:<br>            jmp_code = <span class="hljs-string">&quot;jmp _&quot;</span> + <span class="hljs-built_in">hex</span>(node.child1) + <span class="hljs-string">&quot;\n&quot;</span><br>        <span class="hljs-keyword">else</span>:<br>            jmp_code = <span class="hljs-string">&#x27;\n&#x27;</span><br><br>        all_asm += jmp_code<br><br>    all_asm = all_asm.replace(<span class="hljs-string">&quot;endbr64&quot;</span>, <span class="hljs-string">&quot;nop\n&quot;</span> * <span class="hljs-number">4</span>)<br>    code_bin = asm(all_asm)<br>    <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;1.bin&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>).write(code_bin)<br>    print(all_asm)<br>    print(<span class="hljs-string">&quot;all nodes: &quot;</span>, <span class="hljs-built_in">len</span>(log_map))<br><br>buildNode(<span class="hljs-number">0x3265B1F5</span>, <span class="hljs-number">0x1000</span>)<br></code></pre></td></tr></table></figure>



<h2 id="6-提取出来的代码分析"><a href="#6-提取出来的代码分析" class="headerlink" title="6. 提取出来的代码分析"></a>6. 提取出来的代码分析</h2><p>重建控制流，输出 bin 后，代码比较清晰了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-comment">// rsp = 0x7777F000</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> __noreturn <span class="hljs-title">sub_4</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">unsigned</span> __int8 v0; <span class="hljs-comment">// al</span><br>  <span class="hljs-keyword">int</span> v1; <span class="hljs-comment">// eax</span><br>  __int64 v2; <span class="hljs-comment">// rax</span><br>  __int64 xorKey[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-2C0h]</span><br>  __int128 v4; <span class="hljs-comment">// [rsp+21h] [rbp-29Fh] BYREF</span><br>  <span class="hljs-keyword">char</span> v5[<span class="hljs-number">14</span>]; <span class="hljs-comment">// [rsp+31h] [rbp-28Fh] BYREF</span><br>  <span class="hljs-keyword">char</span> v6[<span class="hljs-number">17</span>]; <span class="hljs-comment">// [rsp+3Fh] [rbp-281h] BYREF</span><br>  __int64 compare[<span class="hljs-number">5</span>]; <span class="hljs-comment">// [rsp+50h] [rbp-270h] BYREF</span><br>  __int64 v8; <span class="hljs-comment">// [rsp+78h] [rbp-248h]</span><br>  __int64 FlagInData[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+80h] [rbp-240h] BYREF</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v10; <span class="hljs-comment">// [rsp+C2h] [rbp-1FEh]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v11; <span class="hljs-comment">// [rsp+C3h] [rbp-1FDh]</span><br>  <span class="hljs-keyword">int</span> kk; <span class="hljs-comment">// [rsp+C4h] [rbp-1FCh]</span><br>  __int64 v13; <span class="hljs-comment">// [rsp+C8h] [rbp-1F8h]</span><br>  __int128 *v14; <span class="hljs-comment">// [rsp+D0h] [rbp-1F0h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v15; <span class="hljs-comment">// [rsp+DAh] [rbp-1E6h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v16; <span class="hljs-comment">// [rsp+DBh] [rbp-1E5h]</span><br>  <span class="hljs-keyword">int</span> mm; <span class="hljs-comment">// [rsp+DCh] [rbp-1E4h]</span><br>  __int64 v18; <span class="hljs-comment">// [rsp+E0h] [rbp-1E0h]</span><br>  __int64 v19; <span class="hljs-comment">// [rsp+E8h] [rbp-1D8h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v20; <span class="hljs-comment">// [rsp+F3h] [rbp-1CDh]</span><br>  <span class="hljs-keyword">int</span> jj; <span class="hljs-comment">// [rsp+F4h] [rbp-1CCh]</span><br>  __int64 v22; <span class="hljs-comment">// [rsp+F8h] [rbp-1C8h]</span><br>  __int64 *v23; <span class="hljs-comment">// [rsp+100h] [rbp-1C0h]</span><br>  __int64 *v24; <span class="hljs-comment">// [rsp+108h] [rbp-1B8h]</span><br>  <span class="hljs-keyword">int</span> ii; <span class="hljs-comment">// [rsp+110h] [rbp-1B0h]</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v26; <span class="hljs-comment">// [rsp+114h] [rbp-1ACh]</span><br>  <span class="hljs-keyword">int</span> v27; <span class="hljs-comment">// [rsp+118h] [rbp-1A8h]</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> v28; <span class="hljs-comment">// [rsp+11Ch] [rbp-1A4h]</span><br>  <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *v29; <span class="hljs-comment">// [rsp+120h] [rbp-1A0h]</span><br>  <span class="hljs-keyword">int</span> n; <span class="hljs-comment">// [rsp+12Ch] [rbp-194h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v31; <span class="hljs-comment">// [rsp+130h] [rbp-190h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v32; <span class="hljs-comment">// [rsp+138h] [rbp-188h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v33; <span class="hljs-comment">// [rsp+140h] [rbp-180h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 data2; <span class="hljs-comment">// [rsp+148h] [rbp-178h]</span><br>  <span class="hljs-keyword">int</span> m; <span class="hljs-comment">// [rsp+154h] [rbp-16Ch]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v36; <span class="hljs-comment">// [rsp+158h] [rbp-168h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 data1; <span class="hljs-comment">// [rsp+160h] [rbp-160h]</span><br>  <span class="hljs-keyword">int</span> i_0; <span class="hljs-comment">// [rsp+16Ch] [rbp-154h]</span><br>  __int64 v39; <span class="hljs-comment">// [rsp+170h] [rbp-150h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 from_t0; <span class="hljs-comment">// [rsp+178h] [rbp-148h]</span><br>  __int64 const_32; <span class="hljs-comment">// [rsp+180h] [rbp-140h]</span><br>  __int64 *flag_ptr; <span class="hljs-comment">// [rsp+188h] [rbp-138h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 v43; <span class="hljs-comment">// [rsp+190h] [rbp-130h]</span><br>  __int64 v44; <span class="hljs-comment">// [rsp+198h] [rbp-128h]</span><br>  __int64 *v45; <span class="hljs-comment">// [rsp+1A0h] [rbp-120h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v46; <span class="hljs-comment">// [rsp+202h] [rbp-BEh]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v47; <span class="hljs-comment">// [rsp+203h] [rbp-BDh]</span><br>  <span class="hljs-keyword">int</span> nn; <span class="hljs-comment">// [rsp+204h] [rbp-BCh]</span><br>  __int64 v49; <span class="hljs-comment">// [rsp+208h] [rbp-B8h]</span><br>  <span class="hljs-keyword">char</span> *v50; <span class="hljs-comment">// [rsp+210h] [rbp-B0h]</span><br>  __int64 flagLen; <span class="hljs-comment">// [rsp+218h] [rbp-A8h]</span><br>  __int64 *v52; <span class="hljs-comment">// [rsp+220h] [rbp-A0h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v53; <span class="hljs-comment">// [rsp+22Ah] [rbp-96h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v54; <span class="hljs-comment">// [rsp+22Bh] [rbp-95h]</span><br>  <span class="hljs-keyword">int</span> i1; <span class="hljs-comment">// [rsp+22Ch] [rbp-94h]</span><br>  __int64 v56; <span class="hljs-comment">// [rsp+230h] [rbp-90h]</span><br>  <span class="hljs-keyword">char</span> *v57; <span class="hljs-comment">// [rsp+238h] [rbp-88h]</span><br>  __int64 v58; <span class="hljs-comment">// [rsp+240h] [rbp-80h]</span><br>  __int64 time0; <span class="hljs-comment">// [rsp+248h] [rbp-78h]</span><br>  __int64 v60; <span class="hljs-comment">// [rsp+250h] [rbp-70h]</span><br>  __int64 d2; <span class="hljs-comment">// [rsp+258h] [rbp-68h]</span><br>  __int64 v62; <span class="hljs-comment">// [rsp+260h] [rbp-60h]</span><br>  __int64 d1; <span class="hljs-comment">// [rsp+268h] [rbp-58h]</span><br>  <span class="hljs-keyword">int</span> i; <span class="hljs-comment">// [rsp+274h] [rbp-4Ch]</span><br>  __int64 data0; <span class="hljs-comment">// [rsp+278h] [rbp-48h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v66; <span class="hljs-comment">// [rsp+282h] [rbp-3Eh]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v67; <span class="hljs-comment">// [rsp+283h] [rbp-3Dh]</span><br>  <span class="hljs-keyword">int</span> j; <span class="hljs-comment">// [rsp+284h] [rbp-3Ch]</span><br>  __int64 v69; <span class="hljs-comment">// [rsp+288h] [rbp-38h]</span><br>  <span class="hljs-keyword">char</span> *v70; <span class="hljs-comment">// [rsp+290h] [rbp-30h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v71; <span class="hljs-comment">// [rsp+29Ah] [rbp-26h]</span><br>  <span class="hljs-keyword">unsigned</span> __int8 v72; <span class="hljs-comment">// [rsp+29Bh] [rbp-25h]</span><br>  <span class="hljs-keyword">int</span> k; <span class="hljs-comment">// [rsp+29Ch] [rbp-24h]</span><br>  __int64 v74; <span class="hljs-comment">// [rsp+2A0h] [rbp-20h]</span><br>  __int64 *flagIn; <span class="hljs-comment">// [rsp+2A8h] [rbp-18h]</span><br>  __int64 v76; <span class="hljs-comment">// [rsp+2B0h] [rbp-10h]</span><br>  <span class="hljs-keyword">unsigned</span> __int64 time0_1; <span class="hljs-comment">// [rsp+2B8h] [rbp-8h]</span><br><br>  v58 = <span class="hljs-number">0x7177625F32303231</span>i64;<br>  __writefsqword(<span class="hljs-number">0</span>, <span class="hljs-number">0x7177625F32303231</span>ui64);<br>  __asm &#123; syscall; Low latency system call &#125;<br>  time0 = MEMORY[<span class="hljs-number">0x1337</span>];                       <span class="hljs-comment">// time(0)</span><br>  time0_1 = MEMORY[<span class="hljs-number">0x1337</span>];<br>  v2 = MEMORY[<span class="hljs-number">0x1337</span>] / <span class="hljs-number">0xE10</span>ui64;<br>  data0 = MEMORY[<span class="hljs-number">0x1337</span>] / <span class="hljs-number">0xE10</span>ui64;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i != <span class="hljs-number">256</span>; ++i )<br>  &#123;<br>    d1 = <span class="hljs-number">0</span>i64;<br>    d1 = *(_QWORD *)v2;<br>    v62 = d1;<br>    d2 = <span class="hljs-number">0</span>i64;<br>    d2 = *(_QWORD *)(d1 + <span class="hljs-number">1</span>);<br>    v60 = d2;<br>    data0 = __ROL8__((data0 ^ d1) + d2 + <span class="hljs-number">33</span> * data0 + <span class="hljs-number">1</span>, <span class="hljs-number">13</span>);<br>    <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>      data0 = v60 ^ (v62 + data0);<br>    <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">2</span>) != <span class="hljs-number">0</span> )<br>      data0 ^= v62 + v60;<br>    <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">4</span>) != <span class="hljs-number">0</span> )<br>      data0 ^= v60 ^ v62;<br>    v2 = i &amp; <span class="hljs-number">8</span>;<br>    <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">8</span>) != <span class="hljs-number">0</span> )<br>    &#123;<br>      v2 = data0 + v62 + v60;<br>      data0 = v2;<br>    &#125;<br>  &#125;<br>  v76 = data0;<br>  <span class="hljs-built_in">strcpy</span>(v6, <span class="hljs-string">&quot;input flag:\n&quot;</span>);<br>  v70 = v6;<br>  v69 = <span class="hljs-number">12</span>i64;<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; v69 != j; ++j )<br>  &#123;<br>    v67 = v70[j];<br>    v66 = v67;<br>    __outbyte(<span class="hljs-number">1u</span>, v67);                         <span class="hljs-comment">// putchar</span><br>  &#125;<br>  <span class="hljs-built_in">memset</span>(FlagInData, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(FlagInData));<br>  flagIn = FlagInData;<br>  v74 = <span class="hljs-number">0x40</span>i64;<br>  <span class="hljs-keyword">for</span> ( k = <span class="hljs-number">0</span>; ; ++k )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( v74 == k )<br>      <span class="hljs-keyword">goto</span> LABEL_3;<br>    v0 = __inbyte(<span class="hljs-number">0</span>);                           <span class="hljs-comment">// get_char</span><br>    v72 = v0;<br>    v71 = v0;<br>    <span class="hljs-keyword">if</span> ( v0 == <span class="hljs-string">&#x27;\n&#x27;</span> )<br>      <span class="hljs-keyword">break</span>;<br>    *((_BYTE *)flagIn + k) = v71;<br>  &#125;<br>  *((_BYTE *)flagIn + k) = <span class="hljs-number">0</span>;<br>LABEL_3:<br>  <span class="hljs-keyword">if</span> ( v76 == <span class="hljs-number">0x1C986C3B22EA63E5</span>i64 )<br>  &#123;<br>    v52 = FlagInData;<br>    <span class="hljs-keyword">for</span> ( flagLen = <span class="hljs-number">0</span>i64; *((_BYTE *)v52 + flagLen); ++flagLen )<br>      ;<br>    v8 = flagLen;<br>    <span class="hljs-keyword">if</span> ( flagLen == <span class="hljs-number">32</span> )<br>    &#123;<br>      v45 = FlagInData;<br>      v44 = <span class="hljs-number">32</span>i64;<br>      v43 = time0_1 / <span class="hljs-number">0xE10</span>;<br>      flag_ptr = FlagInData;<br>      const_32 = <span class="hljs-number">32</span>i64;<br>      from_t0 = time0_1 / <span class="hljs-number">0xE10</span>;<br>      v39 = <span class="hljs-number">0x5249415452455451</span>i64;<br>      __writefsqword(<span class="hljs-number">0</span>, <span class="hljs-number">0x5249415452455451</span>ui64);<br>      <span class="hljs-keyword">for</span> ( i_0 = <span class="hljs-number">0</span>; const_32 != i_0; ++i_0 )<br>      &#123;<br>        data1 = __readfsqword(<span class="hljs-number">0</span>);               <span class="hljs-comment">// 0x5249415452455451</span><br>        v36 = i_0;<br>        <span class="hljs-keyword">for</span> ( m = <span class="hljs-number">0</span>; m != <span class="hljs-number">256</span>; ++m )<br>        &#123;<br>          data2 = __readfsqword(<span class="hljs-number">0</span>);<br>          v33 = data2;<br>          v32 = data2;<br>          v31 = data2;<br>          v36 = (v36 ^ data2) + data2 + <span class="hljs-number">0x21</span> * v36 + <span class="hljs-number">1</span>;<br>          v36 = __ROL8__(v36, <span class="hljs-number">13</span>);<br>          <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>            v36 = v31 ^ (v33 + v36);<br>          <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">2</span>) != <span class="hljs-number">0</span> )<br>            v36 ^= v33 + v31;<br>          <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">4</span>) != <span class="hljs-number">0</span> )<br>            v36 ^= v31 ^ v33;<br>          <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">8</span>) != <span class="hljs-number">0</span> )<br>            v36 += v33 + v31;<br>        &#125;<br>        *((_BYTE *)flag_ptr + i_0) ^= (_BYTE)data1 + (_BYTE)v36;<br>      &#125;<br>      <span class="hljs-keyword">for</span> ( n = <span class="hljs-number">0</span>; const_32 != n; n += <span class="hljs-number">4</span> )      <span class="hljs-comment">// 4字节一组</span><br>      &#123;<br>        v29 = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)((<span class="hljs-keyword">char</span> *)flag_ptr + n);<br>        v28 = *v29;<br>        v27 = <span class="hljs-number">0</span>;<br>        v26 = v28;<br>        v28 = from_t0 + _mm_crc32_u32(<span class="hljs-number">0</span>, v28);<br>        *v29 = v28;<br>      &#125;<br>      xorKey[<span class="hljs-number">0</span>] = <span class="hljs-number">0x178DEC4F232DDB6E</span>i64;<br>      xorKey[<span class="hljs-number">1</span>] = <span class="hljs-number">0xC2AAB7D6D2A167C3</span>ui64;<br>      xorKey[<span class="hljs-number">2</span>] = <span class="hljs-number">0xF1AB91F72761A80F</span>ui64;<br>      xorKey[<span class="hljs-number">3</span>] = <span class="hljs-number">0x3DCEDC28076C41A</span>i64;<br>      <span class="hljs-keyword">for</span> ( ii = <span class="hljs-number">0</span>; v44 != ii; ++ii )<br>        *((_BYTE *)v45 + ii) ^= *((_BYTE *)xorKey + ii);<br>      compare[<span class="hljs-number">0</span>] = <span class="hljs-number">0x3EC81D9432CEF584</span>i64;<br>      compare[<span class="hljs-number">1</span>] = <span class="hljs-number">0xB649A4DCD6BD24FE</span>ui64;<br>      compare[<span class="hljs-number">2</span>] = <span class="hljs-number">0xC5927F0B767A787D</span>ui64;<br>      compare[<span class="hljs-number">3</span>] = <span class="hljs-number">0x1F245B7F751BB52E</span>i64;<br>      v24 = FlagInData;<br>      v23 = compare;<br>      v22 = v8;<br>      <span class="hljs-keyword">for</span> ( jj = <span class="hljs-number">0</span>; ; ++jj )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( v22 == jj )<br>        &#123;<br>          v1 = <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">goto</span> LABEL_47;<br>        &#125;<br>        v20 = *((_BYTE *)v24 + jj) - *((_BYTE *)v23 + jj);<br>        <span class="hljs-keyword">if</span> ( v20 )<br>          <span class="hljs-keyword">break</span>;<br>      &#125;<br>      v1 = v20;<br>LABEL_47:<br>      <span class="hljs-keyword">if</span> ( v1 )<br>      &#123;<br>        <span class="hljs-built_in">strcpy</span>((<span class="hljs-keyword">char</span> *)&amp;v4, <span class="hljs-string">&quot;wrong\n&quot;</span>);<br>        v14 = &amp;v4;<br>        v13 = <span class="hljs-number">6</span>i64;<br>        <span class="hljs-keyword">for</span> ( kk = <span class="hljs-number">0</span>; v13 != kk; ++kk )<br>        &#123;<br>          v11 = *((_BYTE *)v14 + kk);<br>          v10 = v11;<br>          __outbyte(<span class="hljs-number">1u</span>, v11);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        <span class="hljs-built_in">strcpy</span>((<span class="hljs-keyword">char</span> *)&amp;v4 + <span class="hljs-number">7</span>, <span class="hljs-string">&quot;correct\n&quot;</span>);<br>        v19 = (__int64)&amp;v4 + <span class="hljs-number">7</span>;<br>        v18 = <span class="hljs-number">8</span>i64;<br>        <span class="hljs-keyword">for</span> ( mm = <span class="hljs-number">0</span>; v18 != mm; ++mm )<br>        &#123;<br>          v16 = *(_BYTE *)(mm + v19);<br>          v15 = v16;<br>          __outbyte(<span class="hljs-number">1u</span>, v16);<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-built_in">strcpy</span>(v5, <span class="hljs-string">&quot;wrong\n&quot;</span>);<br>      v50 = v5;<br>      v49 = <span class="hljs-number">6</span>i64;<br>      <span class="hljs-keyword">for</span> ( nn = <span class="hljs-number">0</span>; v49 != nn; ++nn )<br>      &#123;<br>        v47 = v50[nn];<br>        v46 = v47;<br>        __outbyte(<span class="hljs-number">1u</span>, v47);<br>      &#125;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    *(_DWORD *)&amp;v5[7] = &#x27;norw&#x27;;<br>    *(_WORD *)&amp;v5[11] = &#x27;\ng&#x27;;<br>    v5[<span class="hljs-number">13</span>] = <span class="hljs-number">0</span>;<br>    v57 = &amp;v5[<span class="hljs-number">7</span>];<br>    v56 = <span class="hljs-number">6</span>i64;<br>    <span class="hljs-keyword">for</span> ( i1 = <span class="hljs-number">0</span>; v56 != i1; ++i1 )<br>    &#123;<br>      v54 = v57[i1];<br>      v53 = v54;<br>      __outbyte(<span class="hljs-number">1u</span>, v54);<br>    &#125;<br>  &#125;<br>  __halt();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>程序入口调用 syscall，由 unicorn 回调处理获取 time(0) 的值，并根据该值计算一个数 0x1C986C3B22EA63E5</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210614143020439.png" srcset="/img/loading.gif" lazyload class="" title="image-20210614143020439">为了屏蔽 ida 的优化，方便分析，我做了一些小 patch

<ul>
<li>syscall 的 unicorn 回调会修改 rax 寄存器，但是 ida 认为 rax 的值是一个可计算的常数，于是后面与 rax 有关的表达式都被优化。</li>
<li>for 循环中读取了两次 fs:0 , 有unicorn回调，每次读取的值肯定不一样，ida 认为两次读取的值一样，于是优化成一次访问。</li>
</ul>
<p>手动 patch ，即可解决这些问题。</p>
<p>有两种爆破思路：</p>
<ul>
<li>直接爆破 time(0)</li>
<li>根据 flag 信息反向爆破</li>
</ul>
<p>可以用 flag 开头来爆破 time(0) 时间常数</p>
<p>from_t0 = time_0 / 0xE10;</p>
<img src="/2021/06/14/%E5%BC%BA%E7%BD%91%E6%9D%AF-unicorn-like-a-pro/image-20210614142739068.png" srcset="/img/loading.gif" lazyload class="" title="image-20210614142739068">

<p>由于 4字节一组，<code>qwb&#123;</code>与<code>QWB&#123;</code> 与 <code>flag</code> 与 <code>FLAG</code> 都是已知的 4 个字节并且 v28 可以非常轻松的获得</p>
<p>通过爆破开头也可以反推 time(0)</p>
<p>爆破出 time(0) 后的做法就是非常简单的计算任务了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&quot;ida.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;x86intrin.h&gt;</span></span><br><br><br><span class="hljs-keyword">static</span> uint64  fs_0;<br><span class="hljs-function">uint64 <span class="hljs-title">getFS0</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// v7[0] = 8461816625668189699LL * v7[0] + 841540768324766462LL;</span><br>    fs_0 = <span class="hljs-number">0x756E69636F726E03</span> * fs_0 + <span class="hljs-number">0xBADC0DEC001CAFE</span>;<br>    <span class="hljs-keyword">return</span> fs_0;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setFSO</span><span class="hljs-params">(<span class="hljs-keyword">int64_t</span> val)</span> </span>&#123;<br>    fs_0 = val;<br>&#125;<br><br><span class="hljs-function">uint64 <span class="hljs-title">test_time</span><span class="hljs-params">(uint64 time)</span> </span>&#123;<br>    uint64  v35;<br>    setFSO(<span class="hljs-number">0x7177625F32303231</span>);<br><br>    uint64 v2 = time ;<br>    uint64  data0 = time ;<br>    uint64 d1, d2,v62, v60;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i != <span class="hljs-number">256</span>; ++i )<br>    &#123;<br>        d1 = <span class="hljs-number">0</span>;<br>        d1 = getFS0();<br>        v62 = d1;<br>        d2 = getFS0();<br>        v60 = d2;<br>        data0 = __ROL8__((data0 ^ d1) + d2 + <span class="hljs-number">33</span> * data0 + <span class="hljs-number">1</span>, <span class="hljs-number">13</span>);<br>        <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>            data0 = v60 ^ (v62 + data0);<br>        <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">2</span>) != <span class="hljs-number">0</span> )<br>            data0 ^= v62 + v60;<br>        <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">4</span>) != <span class="hljs-number">0</span> )<br>            data0 ^= v60 ^ v62;<br>        v2 = i &amp; <span class="hljs-number">8</span>;<br>        <span class="hljs-keyword">if</span> ( (i &amp; <span class="hljs-number">8</span>) != <span class="hljs-number">0</span> )<br>        &#123;<br>            v2 = data0 + v62 + v60;<br>            data0 = v2;<br>        &#125;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p ==\n&quot;</span>, data0);<br>    <span class="hljs-keyword">return</span> data0;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;Hello, World!&quot;</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-keyword">unsigned</span> __int64 compare[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">unsigned</span> __int64 xorKey[<span class="hljs-number">4</span>];<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> flags[] = &#123;<span class="hljs-number">0x67616c66</span>, <span class="hljs-number">0x47414c46</span>, <span class="hljs-number">0x7b627771</span>, <span class="hljs-number">0x7b425751</span>&#125;;<br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> xorkey0[<span class="hljs-number">32</span>] = &#123;<span class="hljs-number">0</span>&#125;;<br>    uint32  * xorkey0_4 = (uint32  *)xorkey0;<br>    compare[<span class="hljs-number">0</span>] = <span class="hljs-number">0x3EC81D9432CEF584</span>; <span class="hljs-comment">// flag, FLAG, qwb&#123; ,QWB&#123;</span><br>    compare[<span class="hljs-number">1</span>] = <span class="hljs-number">0xB649A4DCD6BD24FE</span>;<br>    compare[<span class="hljs-number">2</span>] = <span class="hljs-number">0xC5927F0B767A787D</span>;<br>    compare[<span class="hljs-number">3</span>] = <span class="hljs-number">0x1F245B7F751BB52E</span>;<br>    xorKey[<span class="hljs-number">0</span>] = <span class="hljs-number">0x178DEC4F232DDB6E</span>;<br>    xorKey[<span class="hljs-number">1</span>] = <span class="hljs-number">0xC2AAB7D6D2A167C3</span>;<br>    xorKey[<span class="hljs-number">2</span>] = <span class="hljs-number">0xF1AB91F72761A80F</span>;<br>    xorKey[<span class="hljs-number">3</span>] = <span class="hljs-number">0x3DCEDC28076C41A</span>;<br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> * compare_4 = (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> *)compare;<br><br><br>    <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> fs;<br>    uint64 v35, v36, v33,v32, v31, v30;<br>    setFSO(<span class="hljs-number">0x5249415452455451</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i_0 = <span class="hljs-number">0</span>; <span class="hljs-number">32</span> != i_0; ++i_0 )<br>    &#123;<br>        uint64 data0 = getFS0();               <span class="hljs-comment">// 0x5249415452455451</span><br>        v35 = i_0;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> m = <span class="hljs-number">0</span>; m != <span class="hljs-number">256</span>; ++m )<br>        &#123;<br>            uint64 data1 = getFS0();<br>            uint64 data2 = getFS0();<br>            v35 = (v35 ^ data1) + data2 + <span class="hljs-number">0x21</span> * v35 + <span class="hljs-number">1</span>;<br><br>            v35 = __ROL8__(v35, <span class="hljs-number">13</span>);<br>            <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>                v35 = data2 ^ (data1 + v35);<br>            <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">2</span>) != <span class="hljs-number">0</span> )<br>                v35 ^= data2 + data1;<br>            <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">4</span>) != <span class="hljs-number">0</span> )<br>                v35 ^= data2 ^ data1;<br>            <span class="hljs-keyword">if</span> ( (m &amp; <span class="hljs-number">8</span>) != <span class="hljs-number">0</span> )<br>                v35 += data2 + data1;<br>        &#125;<br>        xorkey0[i_0] =  (_BYTE)data0 + (_BYTE)v35;<br>    &#125;<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">4</span>; k++) &#123;<br>        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> * data = (<span class="hljs-keyword">unsigned</span>  <span class="hljs-keyword">char</span> *)&amp;flags[k];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span> ; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>            data[i] ^= xorkey0[i];<br>        &#125;<br>       <span class="hljs-comment">// printf(&quot;%x\n&quot;, flags[k]);</span><br>    &#125;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> ii = <span class="hljs-number">0</span>; <span class="hljs-number">32</span> != ii; ++ii )<br>        *((_BYTE *)compare + ii) ^= *((_BYTE *)xorKey + ii);<br><br><br>    uint64 targetTT = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<br>    &#123;<br>        <span class="hljs-comment">// v27 = from_t0 + _mm_crc32_u32(0, v27);</span><br>      <span class="hljs-comment">//  unsigned int from_t0 = compare_4[0] - _mm_crc32_u32(0, flags[i]);</span><br>        uint64 tt = compare_4[<span class="hljs-number">0</span>] - _mm_crc32_u32(<span class="hljs-number">0</span>, flags[i]);<br>        uint64 rr = test_time(tt);<br>        <span class="hljs-keyword">if</span> (rr == <span class="hljs-number">0x1c986c3b22ea63e5</span>) &#123;<br>            targetTT = tt;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;val:%p\n&quot;</span>, tt);<br>        &#125;<br>    &#125;<br><br>    uint32 flag_arr[<span class="hljs-number">8</span>];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; ++i) &#123; <span class="hljs-comment">// 4 * 8</span><br>        <span class="hljs-keyword">for</span> (uint32 val = <span class="hljs-number">0</span>; val != <span class="hljs-number">0xffffffff</span>; ++val) &#123;<br>            <span class="hljs-keyword">if</span> (compare_4[i] - targetTT == _mm_crc32_u32(<span class="hljs-number">0</span>, val)) &#123;<br>                flag_arr[i] = val;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; ++i) &#123;<br>        flag_arr[i] ^= xorkey0_4[i];<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s&quot;</span>, (<span class="hljs-keyword">char</span> *)flag_arr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/CTF/">CTF</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Reverse/">Reverse</a>
                    
                      <a class="hover-with-bg" href="/tags/Capstone/">Capstone</a>
                    
                      <a class="hover-with-bg" href="/tags/Unicorn/">Unicorn</a>
                    
                      <a class="hover-with-bg" href="/tags/Keystone/">Keystone</a>
                    
                      <a class="hover-with-bg" href="/tags/Recompile/">Recompile</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/06/11/Unlink-%E4%B8%8E-fastbin-dup-consolidate-%E5%88%A9%E7%94%A8/">
                        <span class="hidden-mobile">Unlink 与 fastbin dup consolidate 利用</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/gitalk@1.7.0/dist/gitalk.min.js', function () {
        var gitalk = new Gitalk({
          clientID: '2e60164d74c132464b61',
          clientSecret: '52a91b30d8b32af23cbb6d7c3ce8950d27240133',
          repo: 'P4nda0s.github.io',
          owner: 'P4nda0s',
          admin: ["P4nda0s"],
          id: '6a5d8185c761d6be3ac88603765a5e9a',
          language: 'zh-CN',
          labels: ["Gitalk"],
          perPage: 10,
          pagerDirection: 'last',
          createIssueManually: true,
          distractionFreeMode: true,
          proxy: 'https://purple-cell-2422.pandaos.workers.dev/?https://github.com/login/oauth/access_token'
        });
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
